{% extends 'base.html' %}

{% block head %}
 {{ super() }}
 <link rel="stylesheet" href="{{ url_for('static',filename='login-stylee.css') }}">
{% endblock %}
{% block title %}Register page{% endblock %}
{% block content %}
<main class="login-page">  <!-- Unique wrapper class -->
    <div class="login-form-wrapper">
      <h2 style="color: rgba(0, 0, 0, 0.778); display:flex;align-items: center; justify-content: center;">Register</h2>
      <form method="POST"  id="registrationForm">
  
         {{ form.hidden_tag() }}
  
         <!-- {{ form.username.label()}} -->
         {{ form.username(class="login-input" ,placeholder="User Name") }}
         {{ form.email_address(class="login-input",placeholder="Email Address") }}
         {{ form.password1(class="login-input" ,placeholder="Password",autocomplete="new-password") }}
         {{ form.confirm_password(class="login-input",placeholder="Confirm Password") }}

         <br>
         <div class="checkbox mb-3" >
            <h6 style="color: rgba(0, 0, 0, 0.777); display:flex;align-items: center; justify-content: center;">Already an user!</h6>
            <a class="btn btn-sm btn-primary" href="{{ url_for('login_page') }}" style="display: block;">Login</a>
         </div>
         {{ form.submit(class="login-btn",placeholder="Create Account") }}
      </form>
    </div>
</main>


<script>
   const form = document.getElementById('registrationForm');
   console.log('Form found:');
   form.addEventListener('submit', async function(e) {
       e.preventDefault();
       const formData = new FormData(this);
       
      
           // 1. Register first
           const registerRes = await fetch('/register', {
               method: "POST",
               body: formData 
           }); 
           
           if (!registerRes.ok) {
               const error = await registerRes.json();
               alert('Registration failed: ' + error.error);
               return;
           }
           
           // 2. Auto-login
           const loginRes = await fetch('/api/login', {
               method: "POST",
               headers: {'Content-Type': 'application/json'},
               body: JSON.stringify({
                   username: formData.get('username'),
                   password: formData.get('password1')
               })
           });
           
           if (loginRes.ok) {
               const loginData = await loginRes.json();
               localStorage.setItem('accessToken', loginData.accessToken);  // âœ… FIXED
               window.location.href = '/add-expense';
           } else {
               alert('Login failed after registration');
           }
      
   });
   </script>

{% endblock %}   